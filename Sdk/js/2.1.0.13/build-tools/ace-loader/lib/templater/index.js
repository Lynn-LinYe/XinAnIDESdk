const validator=require("./validator"),Parser=require("../parse/parser/index");let compileResult;const EVENT_START_REGEXP=/^(on:|on|@|grab:)/,REGEXP_TEXT=/^#/;function parse(e,l,t){compileResult={jsonTemplate:{},deps:[],log:[]};const o=hmlParse(e,{sourceCodeLocationInfo:!0});checkNullNode(o,l)||checkRootNode(o,l)||(generate(o.childNodes.filter(function(e){return-1===e.nodeName.indexOf("#")})[0],t),l(null,compileResult))}function hmlParse(e,l){return new Parser({sourceCodeLocationInfo:!0,validator:validator,compileResult:compileResult}).parseFragment(e,l)}function checkNullNode(e,l){let t=!1;return 0===e.childNodes.length&&(compileResult.log.push({reason:"ERROR: parsing hml file failed"}),l(null,compileResult),t=!0),t}function checkRootNode(e,l){let t=!1;const o=e.childNodes.filter(function(e){return-1===e.nodeName.indexOf("#")});return 1!==o.length&&(0===o.length&&compileResult.log.push({reason:"ERROR: need a legal root node",line:1,column:1}),o.length>1&&compileResult.log.push({reason:"ERROR: there can only be one root node",line:1,column:1}),l(null,compileResult),t=!0),t}function generate(e,l,t){validator.validateTagName(e,compileResult),e.attrs&&0!==e.attrs.length&&checkNodeAttrs(e,l,t),e.childNodes&&0!==e.childNodes.length&&checkNodeChildren(e,l)}function checkNodeAttrs(e,l,t){const o=e.attrs,a={line:e.sourceCodeLocation.startLine,col:e.sourceCodeLocation.endLine};o.forEach((i,n)=>{const s=i.name,c=i.value;switch(s){case"style":validator.validateStyle(c,compileResult,a);break;case"class":validator.validateClass(c,compileResult);break;case"id":validator.validateId(c,compileResult);break;case"for":validator.validateFor(c,compileResult,a);break;case"if":validator.validateIf(c,compileResult,!1,a);break;case"elif":validator.validateAttrElif(t,c,o,n,compileResult);break;case"else":validator.validateAttrElse(t,compileResult,a);break;case"append":validator.validateAppend(c,compileResult);break;default:EVENT_START_REGEXP.test(s)?validator.validateEvent(s,c,compileResult):validator.validateAttr(l,s,c,compileResult,e.tagName,a)}})}function checkNodeChildren(e,l){const t=e.childNodes.filter(e=>"#text"===e.nodeName&&e.value.trim()||!REGEXP_TEXT.test(e.nodeName)),o=compileResult.jsonTemplate;for(let a=0;a<t.length;a++){const i=t[a];let n;if(a>0&&(n=t[a-1]),REGEXP_TEXT.test(i.nodeName)){if("option"===e.nodeName){validator.validateAttr(l,"content",i.value,compileResult);continue}validator.validateAttr(l,"value",i.value,compileResult)}else compileResult.jsonTemplate={},o.children=o.children||[],o.children.push(compileResult.jsonTemplate),generate(i,l,n)}compileResult.jsonTemplate=o}module.exports={parse:parse};